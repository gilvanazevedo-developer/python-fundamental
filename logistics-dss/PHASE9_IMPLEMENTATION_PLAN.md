# Logistics DSS - Phase 9 Implementation Plan
# Multilingual UI — English, Portuguese & Spanish (i18n)

**Project:** Logistics Decision Support System
**Phase:** 9 — Multilingual UI: English, Portuguese & Spanish
**Author:** Gilvan de Azevedo
**Date:** 2026-02-24
**Status:** Not Started
**Depends on:** Phase 8 (Productionisation) — functionally complete

---

## 1. Phase 9 Objective

Phase 9 fulfils a core business requirement stated in the original project specification: *"Trilingual (English, Portuguese, Spanish)"*. The system already stores a `language` preference in `config/settings.json` and exposes a language dropdown in `SettingsView` — both of which were placeholder stubs in Phase 8. Phase 9 activates them.

The approach is `gettext`-based internationalisation using Python's built-in `gettext` module and standard `.po`/`.mo` locale files. Every user-visible string in the application — navigation labels, view titles, column headers, button text, KPI names, form labels, validation messages, and status badges — is wrapped in a `_()` call that returns the translation for the active locale at runtime. Switching the language in `SettingsView` takes effect immediately without restarting the application: a `TranslationService` observer pattern notifies all registered views to call their `_refresh_labels()` method, updating every widget text in place.

Three locales are delivered:

- **`en`** — English (default; `.po` file serves as the master string catalog)
- **`pt_BR`** — Brazilian Portuguese (primary target market)
- **`es`** — Spanish (secondary target market; covers Latin America and Spain)

~280 unique translatable strings are catalogued across all 14 UI views, the navigation bar, modals, error messages, KPI names, and status badge text. A `tools/extract_strings.py` script automates extraction of new strings from source code into a `.pot` master template, keeping the catalog maintainable as the codebase evolves.

**Deliverables:**
- `locale/en/LC_MESSAGES/logistics_dss.po` — English master string catalog (~280 strings)
- `locale/pt_BR/LC_MESSAGES/logistics_dss.po` — Brazilian Portuguese translations (~280 strings)
- `locale/es/LC_MESSAGES/logistics_dss.po` — Spanish translations (~280 strings)
- `locale/{lang}/LC_MESSAGES/logistics_dss.mo` — Compiled binary catalogs (3 files)
- `src/services/translation_service.py` — `switch_language()`, observer registry, `translate()`, `ntranslate()`
- `src/ui/i18n.py` — `_()` and `ngettext()` application-wide shortcuts
- `src/ui/mixins/i18n_mixin.py` — `I18nMixin` base class with `enable_i18n()`, `_refresh_labels()`, `disable_i18n()`
- All 14 UI views + `app.py` updated: string literals replaced with `_()` calls; `I18nMixin` applied; `_refresh_labels()` implemented
- `SettingsView` language dropdown wired to `TranslationService.switch_language()`
- `App._refresh_all_views()` triggered on language change
- `tools/extract_strings.py` — POT extraction script wrapping `pygettext`
- Updated `packaging/logistics_dss.spec` — `.mo` files added to `datas`
- Full test suite (19 new tests): translation loading, locale completeness, runtime switch

---

## 2. Phase 8 Dependencies (Available)

Phase 9 builds directly on the following Phase 8 (and prior) components:

| Component | Module | Usage in Phase 9 |
|---|---|---|
| `SettingsService` | `src/services/settings_service.py` | `get("language")` returns active locale code; `set("language", lang)` persists selection; defaults to `"en"` |
| `SettingsView` language dropdown | `src/ui/views/settings_view.py` | Already renders `CTkOptionMenu` with `["English", "Português", "Español"]`; Phase 9 wires `command=` to `TranslationService.switch_language()` |
| `App` | `src/ui/app.py` | Extended with `_refresh_all_views()` called by `TranslationService` observer; re-applies sidebar nav labels |
| All 14 UI views | `src/ui/views/` | All receive `I18nMixin`; implement `_refresh_labels()`; string literals replaced with `_()` |
| `LoggerMixin` | `src/logger.py` | Used in `TranslationService` for locale-load logging (log messages remain in English) |
| `packaging/logistics_dss.spec` | `packaging/logistics_dss.spec` | Extended: `locale/` directory added to `datas` so compiled `.mo` files are bundled |
| `config/settings.json` | `config/` | `"language": "en"` default already present in `SETTINGS_DEFAULTS` |
| `SETTINGS_DEFAULTS` constant | `config/constants.py` | `"language": "en"` in defaults dict; no change needed |

---

## 3. Architecture Overview

### 3.1 Phase 9 Directory Structure

```
logistics-dss/
├── locale/                             # NEW directory
│   ├── logistics_dss.pot               # NEW: master POT template (generated by tools/extract_strings.py)
│   ├── en/
│   │   └── LC_MESSAGES/
│   │       ├── logistics_dss.po        # NEW: English master catalog (~280 msgid + msgstr pairs)
│   │       └── logistics_dss.mo        # NEW: compiled binary (msgfmt output)
│   ├── pt_BR/
│   │   └── LC_MESSAGES/
│   │       ├── logistics_dss.po        # NEW: Brazilian Portuguese translations
│   │       └── logistics_dss.mo        # NEW: compiled binary
│   └── es/
│       └── LC_MESSAGES/
│           ├── logistics_dss.po        # NEW: Spanish translations
│           └── logistics_dss.mo        # NEW: compiled binary
├── tools/
│   └── extract_strings.py              # NEW: POT extraction script
├── src/
│   ├── services/
│   │   └── translation_service.py      # NEW: switch_language(), observer registry, translate()
│   └── ui/
│       ├── i18n.py                     # NEW: _() and ngettext() application-wide shortcuts
│       ├── mixins/
│       │   ├── __init__.py             # NEW
│       │   └── i18n_mixin.py           # NEW: I18nMixin base class
│       ├── app.py                      # (existing) + _refresh_all_views() + language init
│       └── views/
│           ├── dashboard_view.py       # (existing) + I18nMixin + _refresh_labels()
│           ├── inventory_view.py       # (existing) + I18nMixin + _refresh_labels()
│           ├── alerts_view.py          # (existing) + I18nMixin + _refresh_labels()
│           ├── forecasting_view.py     # (existing) + I18nMixin + _refresh_labels()
│           ├── optimization_view.py    # (existing) + I18nMixin + _refresh_labels()
│           ├── executive_view.py       # (existing) + I18nMixin + _refresh_labels()
│           ├── reports_view.py         # (existing) + I18nMixin + _refresh_labels()
│           ├── suppliers_view.py       # (existing) + I18nMixin + _refresh_labels()
│           ├── purchase_orders_view.py # (existing) + I18nMixin + _refresh_labels()
│           ├── login_view.py           # (existing) + I18nMixin + _refresh_labels()
│           ├── settings_view.py        # (existing) + I18nMixin + _refresh_labels() + language wiring
│           ├── import_wizard_view.py   # (existing) + I18nMixin + _refresh_labels()
│           └── audit_log_view.py       # (existing) + I18nMixin + _refresh_labels()
├── packaging/
│   └── logistics_dss.spec              # (existing) + locale/ added to datas
└── tests/
    ├── test_translation_service.py     # NEW: 8 tests
    ├── test_locale_completeness.py     # NEW: 6 tests
    └── test_language_switch.py         # NEW: 5 tests
```

### 3.2 Layer Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Presentation Layer (14 views + App)                    │
│                                                                                │
│  All views now implement I18nMixin:                                            │
│  ┌──────────────────────────────────────────────────────────────────────────┐ │
│  │  view.__init__()       → wraps strings in _(); calls enable_i18n()       │ │
│  │  view._refresh_labels() → re-applies _() to all widget .configure(text=) │ │
│  │  view.destroy()        → calls disable_i18n() to deregister observer     │ │
│  └──────────────────────────────────────────────────────────────────────────┘ │
│                                                                                │
│  i18n.py: _("text") → TranslationService.translate("text")                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                       Translation Service Layer (NEW)                          │
│  ┌──────────────────────────────────────────────────────────────────────────┐ │
│  │  TranslationService                                                       │ │
│  │  switch_language(lang)  → loads .mo; notifies observers                  │ │
│  │  translate(text)        → _current_translation.gettext(text)             │ │
│  │  ntranslate(s, p, n)    → _current_translation.ngettext(s, p, n)        │ │
│  │  subscribe(callback)    → registers view._on_language_changed            │ │
│  │  unsubscribe(callback)  → deregisters on view.destroy()                  │ │
│  └──────────────────────────────────────────────────────────────────────────┘ │
├──────────────────────────────────────────────────────────────────────────────┤
│                          Locale File Layer (NEW)                               │
│  ┌────────────┐  ┌──────────────────────────┐  ┌────────────────────────┐   │
│  │  en .mo    │  │  pt_BR .mo               │  │  es .mo                │   │
│  │ (fallback) │  │ (Brazilian Portuguese)    │  │ (Spanish)              │   │
│  └────────────┘  └──────────────────────────┘  └────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Component Design

### 4.1 `TranslationService` (`src/services/translation_service.py`)

The service is implemented as a module with module-level state (not a class instance) to allow the `_()` shorthand in `i18n.py` to access it without passing a reference.

```python
"""
TranslationService — runtime locale switching with observer notification.

Usage:
    from src.services.translation_service import switch_language, subscribe

    switch_language("pt_BR")        # loads pt_BR .mo; notifies all observers
    switch_language("en")           # revert to English
"""

import gettext
import logging
from pathlib import Path
from typing import Callable

_logger = logging.getLogger(__name__)

# Active GNUTranslations object; NullTranslations returns msgid unchanged (English fallback)
_current: gettext.NullTranslations = gettext.NullTranslations()
_current_lang: str = "en"
_observers: list[Callable[[str], None]] = []

_LOCALE_DIR = Path(__file__).parent.parent.parent / "locale"
_DOMAIN = "logistics_dss"


def switch_language(lang: str) -> None:
    """Load the .mo file for `lang` and notify all registered view callbacks."""
    global _current, _current_lang
    try:
        t = gettext.translation(_DOMAIN, localedir=str(_LOCALE_DIR), languages=[lang])
        _current = t
        _current_lang = lang
        _logger.info("Language switched to '%s'", lang)
    except FileNotFoundError:
        # Locale file not found; silently fall back to English (NullTranslations)
        _current = gettext.NullTranslations()
        _current_lang = "en"
        _logger.warning("Locale file for '%s' not found; falling back to English.", lang)
    for callback in list(_observers):
        try:
            callback(lang)
        except Exception:
            _logger.exception("Observer callback raised during language switch.")


def get_current_language() -> str:
    return _current_lang


def translate(text: str) -> str:
    return _current.gettext(text)


def ntranslate(singular: str, plural: str, n: int) -> str:
    return _current.ngettext(singular, plural, n)


def subscribe(callback: Callable[[str], None]) -> None:
    if callback not in _observers:
        _observers.append(callback)


def unsubscribe(callback: Callable[[str], None]) -> None:
    if callback in _observers:
        _observers.remove(callback)
```

| Method | Returns | Description |
|---|---|---|
| `switch_language(lang)` | `None` | Loads `locale/{lang}/LC_MESSAGES/logistics_dss.mo`; falls back silently to `NullTranslations` if file absent; notifies all observers |
| `get_current_language()` | `str` | Returns active locale code (`"en"`, `"pt_BR"`, `"es"`) |
| `translate(text)` | `str` | Returns translated string; returns `text` unchanged if no translation found (English fallback) |
| `ntranslate(singular, plural, n)` | `str` | Plural-aware translation using locale-specific plural formula |
| `subscribe(callback)` | `None` | Registers a `Callable[[str], None]` observer; called on every `switch_language()` |
| `unsubscribe(callback)` | `None` | Removes observer; called in `I18nMixin.disable_i18n()` on view destruction |

---

### 4.2 `i18n.py` (`src/ui/i18n.py`)

Application-wide shorthand imported by all views and service error-message constants:

```python
"""
i18n.py — application-wide translation shortcuts.

Import with:
    from src.ui.i18n import _, ngettext
"""

from src.services.translation_service import translate, ntranslate


def _(text: str) -> str:
    """Return the translation of `text` in the current locale."""
    return translate(text)


def ngettext(singular: str, plural: str, n: int) -> str:
    """Return the plural-correct translation for `n` items."""
    return ntranslate(singular, plural, n)
```

All UI string literals are replaced with `_("...")`. Example conversions:

```python
# Before (Phase 8):
self._title = CTkLabel(self, text="Purchase Orders")
self._submit_btn = CTkButton(self, text="Submit")

# After (Phase 9):
from src.ui.i18n import _
self._title = CTkLabel(self, text=_("Purchase Orders"))
self._submit_btn = CTkButton(self, text=_("Submit"))
```

---

### 4.3 `I18nMixin` (`src/ui/mixins/i18n_mixin.py`)

Applied to all 14 view classes and `App`. Provides the observer registration lifecycle and a `_refresh_labels()` hook implemented per view.

```python
"""
I18nMixin — adds runtime language-switch support to any CTkFrame view.

Usage:
    class MyView(CTkFrame, I18nMixin):
        def __init__(self, master, **kwargs):
            super().__init__(master, **kwargs)
            # ... create widgets using _() ...
            self.enable_i18n()          # register observer AFTER widgets exist

        def _refresh_labels(self) -> None:
            self._title.configure(text=_("My View Title"))
            self._btn.configure(text=_("Click Me"))
            # rebuild any DataTable headers or CTkOptionMenu values

        def destroy(self) -> None:
            self.disable_i18n()         # deregister BEFORE widget destruction
            super().destroy()
"""

from src.services import translation_service


class I18nMixin:

    def enable_i18n(self) -> None:
        """Register this view for language-change notifications."""
        translation_service.subscribe(self._on_language_changed)

    def disable_i18n(self) -> None:
        """Deregister to prevent callbacks to a destroyed widget."""
        translation_service.unsubscribe(self._on_language_changed)

    def _on_language_changed(self, new_lang: str) -> None:
        """Called by TranslationService on every switch_language(). Thread-safe."""
        if self.winfo_exists():
            # Schedule on the Tkinter main thread to avoid cross-thread widget access
            self.after(0, self._refresh_labels)

    def _refresh_labels(self) -> None:
        """Override in each view: re-configure all widget texts using _()."""
        pass
```

**DataTable header refresh strategy:**

`DataTable` column headers are passed as a list of strings at construction time. Since `DataTable` does not support hot-swapping headers, `_refresh_labels()` in views with a data table calls a `_rebuild_table()` helper that re-creates the `DataTable` widget with freshly translated headers. Row data is preserved by re-fetching from the service layer.

```python
# Example in SuppliersView._refresh_labels():
def _refresh_labels(self) -> None:
    self._section_title.configure(text=_("SUPPLIERS"))
    self._add_btn.configure(text=_("+ Add Supplier"))
    self._refresh_btn.configure(text=_("Refresh"))
    # Rebuild table to update column headers:
    self._rebuild_supplier_table()

def _rebuild_supplier_table(self) -> None:
    if hasattr(self, "_table") and self._table.winfo_exists():
        self._table.destroy()
    self._table = DataTable(
        self._table_frame,
        columns=[_("ID"), _("Name"), _("Lead Time (d)"),
                 _("Reliability"), _("Open POs"), _("Active")],
        rows=self._cached_rows,
    )
    self._table.grid(row=0, column=0, sticky="nsew")
```

---

### 4.4 `SettingsView` Language Wiring

The `SettingsView` language dropdown (`CTkOptionMenu`) is wired in Phase 9:

```python
# Phase 8 stub (no command):
self._lang_menu = CTkOptionMenu(self, values=["English", "Português", "Español"])

# Phase 9 (wired):
_LANG_DISPLAY_TO_CODE = {
    "English":   "en",
    "Português": "pt_BR",
    "Español":   "es",
}
_LANG_CODE_TO_DISPLAY = {v: k for k, v in _LANG_DISPLAY_TO_CODE.items()}

self._lang_menu = CTkOptionMenu(
    self,
    values=["English", "Português", "Español"],
    command=self._on_language_selected,
)
# Set to current setting on load:
current_code = SettingsService().get("language", "en")
self._lang_menu.set(_LANG_CODE_TO_DISPLAY.get(current_code, "English"))

def _on_language_selected(self, display_name: str) -> None:
    lang_code = _LANG_DISPLAY_TO_CODE[display_name]
    TranslationService.switch_language(lang_code)
    SettingsService().set("language", lang_code)
    # No toast needed; the live UI update is immediate and self-evident
```

---

### 4.5 `App._refresh_all_views()` Extension

`App` subscribes itself to `TranslationService` to refresh the sidebar navigation labels, which are not part of any view's `_refresh_labels()`:

```python
# In App.__init__():
TranslationService.subscribe(self._on_language_changed)
# Initialise to persisted language on startup:
saved_lang = SettingsService().get("language", "en")
if saved_lang != "en":
    TranslationService.switch_language(saved_lang)

def _on_language_changed(self, new_lang: str) -> None:
    self.after(0, self._refresh_nav_labels)

def _refresh_nav_labels(self) -> None:
    """Re-applies _() to all sidebar navigation button labels."""
    for btn, key in self._nav_buttons:   # _nav_buttons: list[tuple[CTkButton, str]]
        btn.configure(text=_(key))
```

`_nav_buttons` is built in `__init__` as:

```python
self._nav_buttons = [
    (self._btn_dashboard,       "Dashboard"),
    (self._btn_inventory,       "Inventory"),
    (self._btn_forecasting,     "Forecasting"),
    (self._btn_optimization,    "Optimisation"),
    (self._btn_alerts,          "Alerts"),
    (self._btn_executive,       "Executive"),
    (self._btn_reports,         "Reports"),
    (self._btn_suppliers,       "Suppliers"),
    (self._btn_pos,             "Purchase Orders"),
    (self._btn_settings,        "Settings"),
    (self._btn_import,          "Import Data"),
    (self._btn_audit,           "Audit Log"),
]
```

---

### 4.6 Locale File Structure

All `.po` files use UTF-8 encoding and standard gettext headers.

**`locale/en/LC_MESSAGES/logistics_dss.po` (excerpt — English master):**

```po
# Logistics DSS — English (master catalog)
# Copyright (C) 2026 Gilvan de Azevedo
#
msgid ""
msgstr ""
"Project-Id-Version: Logistics DSS 1.0.0\n"
"POT-Creation-Date: 2026-02-24 09:00+0000\n"
"PO-Revision-Date: 2026-02-24 09:00+0000\n"
"Language: en\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=UTF-8\n"
"Content-Transfer-Encoding: 8bit\n"
"Plural-Forms: nplurals=2; plural=(n != 1);\n"

# Navigation
msgid "Dashboard"
msgstr "Dashboard"

msgid "Inventory"
msgstr "Inventory"

msgid "Forecasting"
msgstr "Forecasting"

msgid "Optimisation"
msgstr "Optimisation"

msgid "Alerts"
msgstr "Alerts"

msgid "Executive"
msgstr "Executive"

msgid "Reports"
msgstr "Reports"

msgid "Suppliers"
msgstr "Suppliers"

msgid "Purchase Orders"
msgstr "Purchase Orders"

msgid "Settings"
msgstr "Settings"

msgid "Import Data"
msgstr "Import Data"

msgid "Audit Log"
msgstr "Audit Log"

# Buttons
msgid "Submit"
msgstr "Submit"

msgid "Confirm"
msgstr "Confirm"

msgid "Receive"
msgstr "Receive"

msgid "Cancel"
msgstr "Cancel"

msgid "Save"
msgstr "Save"

msgid "Refresh"
msgstr "Refresh"

msgid "Log In"
msgstr "Log In"
```

**`locale/pt_BR/LC_MESSAGES/logistics_dss.po` (excerpt — Brazilian Portuguese):**

```po
# Logistics DSS — Português (Brasil)
# Copyright (C) 2026 Gilvan de Azevedo
#
msgid ""
msgstr ""
"Project-Id-Version: Logistics DSS 1.0.0\n"
"Language: pt_BR\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=UTF-8\n"
"Content-Transfer-Encoding: 8bit\n"
"Plural-Forms: nplurals=2; plural=(n > 1);\n"

msgid "Dashboard"
msgstr "Painel de Controle"

msgid "Inventory"
msgstr "Estoque"

msgid "Forecasting"
msgstr "Previsão de Demanda"

msgid "Optimisation"
msgstr "Otimização"

msgid "Alerts"
msgstr "Alertas"

msgid "Executive"
msgstr "Executivo"

msgid "Reports"
msgstr "Relatórios"

msgid "Suppliers"
msgstr "Fornecedores"

msgid "Purchase Orders"
msgstr "Ordens de Compra"

msgid "Settings"
msgstr "Configurações"

msgid "Import Data"
msgstr "Importar Dados"

msgid "Audit Log"
msgstr "Registro de Auditoria"

msgid "Submit"
msgstr "Enviar"

msgid "Confirm"
msgstr "Confirmar"

msgid "Receive"
msgstr "Receber"

msgid "Cancel"
msgstr "Cancelar"

msgid "Save"
msgstr "Salvar"

msgid "Refresh"
msgstr "Atualizar"

msgid "Log In"
msgstr "Entrar"
```

**`locale/es/LC_MESSAGES/logistics_dss.po` (excerpt — Spanish):**

```po
# Logistics DSS — Español
# Copyright (C) 2026 Gilvan de Azevedo
#
msgid ""
msgstr ""
"Project-Id-Version: Logistics DSS 1.0.0\n"
"Language: es\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=UTF-8\n"
"Content-Transfer-Encoding: 8bit\n"
"Plural-Forms: nplurals=2; plural=(n != 1);\n"

msgid "Dashboard"
msgstr "Panel de Control"

msgid "Inventory"
msgstr "Inventario"

msgid "Forecasting"
msgstr "Pronóstico de Demanda"

msgid "Optimisation"
msgstr "Optimización"

msgid "Alerts"
msgstr "Alertas"

msgid "Executive"
msgstr "Ejecutivo"

msgid "Reports"
msgstr "Informes"

msgid "Suppliers"
msgstr "Proveedores"

msgid "Purchase Orders"
msgstr "Órdenes de Compra"

msgid "Settings"
msgstr "Configuración"

msgid "Import Data"
msgstr "Importar Datos"

msgid "Audit Log"
msgstr "Registro de Auditoría"

msgid "Submit"
msgstr "Enviar"

msgid "Confirm"
msgstr "Confirmar"

msgid "Receive"
msgstr "Recibir"

msgid "Cancel"
msgstr "Cancelar"

msgid "Save"
msgstr "Guardar"

msgid "Refresh"
msgstr "Actualizar"

msgid "Log In"
msgstr "Iniciar Sesión"
```

---

### 4.7 String Catalog — Categories and Count

| Category | String Count | Example (EN) | Example (PT-BR) | Example (ES) |
|---|---|---|---|---|
| Navigation labels | 12 | "Purchase Orders" | "Ordens de Compra" | "Órdenes de Compra" |
| View titles and section headers | 28 | "SUPPLIERS" | "FORNECEDORES" | "PROVEEDORES" |
| Action buttons | 62 | "Receive…" | "Receber…" | "Recibir…" |
| DataTable column headers | 78 | "Reliability" | "Confiabilidade" | "Confiabilidad" |
| Form / modal field labels | 42 | "Lead Time (days)" | "Prazo de Entrega (dias)" | "Tiempo de Entrega (días)" |
| KPI card labels | 18 | "Supplier On-Time" | "Fornecedor Pontual" | "Proveedor Puntual" |
| Status badge text | 14 | "CONFIRMED" | "CONFIRMADO" | "CONFIRMADO" |
| Error and validation messages | 22 | "Invalid username or password." | "Usuário ou senha inválidos." | "Usuario o contraseña inválidos." |
| Toast / notification messages | 16 | "Draft PO created." | "Rascunho de OC criado." | "Borrador de OC creado." |
| Modal titles | 18 | "Add Supplier" | "Adicionar Fornecedor" | "Agregar Proveedor" |
| **Total (raw)** | **310** | | | |
| **Unique (after dedup)** | **~280** | | | |

**Plural-form strings (6 total):**

| Singular (EN) | Plural (EN) | PT-BR (singular / plural) | ES (singular / plural) |
|---|---|---|---|
| "%(n)d open order" | "%(n)d open orders" | "%(n)d pedido em aberto" / "%(n)d pedidos em aberto" | "%(n)d pedido abierto" / "%(n)d pedidos abiertos" |
| "%(n)d alert" | "%(n)d alerts" | "%(n)d alerta" / "%(n)d alertas" | "%(n)d alerta" / "%(n)d alertas" |
| "%(n)d product" | "%(n)d products" | "%(n)d produto" / "%(n)d produtos" | "%(n)d producto" / "%(n)d productos" |
| "%(n)d supplier" | "%(n)d suppliers" | "%(n)d fornecedor" / "%(n)d fornecedores" | "%(n)d proveedor" / "%(n)d proveedores" |
| "%(n)d row imported" | "%(n)d rows imported" | "%(n)d linha importada" / "%(n)d linhas importadas" | "%(n)d fila importada" / "%(n)d filas importadas" |
| "%(n)d row skipped" | "%(n)d rows skipped" | "%(n)d linha ignorada" / "%(n)d linhas ignoradas" | "%(n)d fila omitida" / "%(n)d filas omitidas" |

**Strings intentionally NOT translated:**

| String | Reason |
|---|---|
| Internal PO status values: `"DRAFT"`, `"SUBMITTED"`, `"CONFIRMED"`, `"RECEIVED"`, `"CANCELLED"` | Stored in the database; translation would break queries and PO number display consistency |
| Log messages | Logs are consumed by developers and support staff; English-only keeps them searchable |
| Cron expressions (`"0 8 * * 1"`) | Technical format; no natural-language representation |
| Currency symbols (`"$"`) | Handled by formatting constants, not translation |

---

### 4.8 `tools/extract_strings.py`

A developer utility that scans all `.py` files in `src/ui/` for `_("...")` and `ngettext("...", "...", ...)` calls, writes a fresh `logistics_dss.pot` master template, and reports any strings present in the current `.po` files but absent from the source (obsolete) or present in the source but absent from `.po` files (untranslated).

```python
#!/usr/bin/env python3
"""
extract_strings.py — extract translatable strings from src/ui/ into logistics_dss.pot.

Usage:
    python tools/extract_strings.py [--check-completeness]

Options:
    --check-completeness  Report missing and obsolete strings in all .po files; exit 1 if any missing.
"""
import argparse
import subprocess
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).parent.parent
SRC_DIR   = REPO_ROOT / "src" / "ui"
LOCALE_DIR = REPO_ROOT / "locale"
DOMAIN     = "logistics_dss"
LOCALES    = ["en", "pt_BR", "es"]


def extract_pot() -> Path:
    pot_path = LOCALE_DIR / f"{DOMAIN}.pot"
    py_files = sorted(SRC_DIR.rglob("*.py"))
    subprocess.run(
        ["python", "-m", "pygettext", "--no-default-keywords",
         "-k", "_", "-k", "ngettext:1,2",
         "-o", str(pot_path), *[str(f) for f in py_files]],
        check=True,
    )
    print(f"POT written: {pot_path} ({len(py_files)} source files scanned)")
    return pot_path


def check_completeness(pot_path: Path) -> int:
    """Returns number of missing translations across all locales."""
    pot_keys = _load_msgids(pot_path)
    total_missing = 0
    for locale in LOCALES:
        po_path = LOCALE_DIR / locale / "LC_MESSAGES" / f"{DOMAIN}.po"
        if not po_path.exists():
            print(f"[MISSING] {po_path} does not exist.")
            total_missing += len(pot_keys)
            continue
        po_keys = _load_msgids(po_path)
        missing  = pot_keys - po_keys
        obsolete = po_keys - pot_keys
        if missing:
            print(f"[{locale}] {len(missing)} MISSING: {sorted(missing)[:3]}...")
            total_missing += len(missing)
        if obsolete:
            print(f"[{locale}] {len(obsolete)} OBSOLETE (can be removed)")
        if not missing and not obsolete:
            print(f"[{locale}] Complete ✓")
    return total_missing
```

---

## 5. Data Flow

### 5.1 Language Switch Flow

```
User opens SettingsView → selects "Português" from language dropdown
    │
    ▼
SettingsView._on_language_selected("Português")
    ├── lang_code = "pt_BR"
    ├── TranslationService.switch_language("pt_BR")
    │       ├── Load locale/pt_BR/LC_MESSAGES/logistics_dss.mo
    │       ├── _current = GNUTranslations(pt_BR .mo)
    │       ├── _current_lang = "pt_BR"
    │       └── For each registered observer:
    │               observer("pt_BR")                   ← fires for all 14 views + App
    │                       │
    │               view._on_language_changed("pt_BR")
    │                       │
    │               view.after(0, view._refresh_labels) ← scheduled on Tkinter main thread
    └── SettingsService().set("language", "pt_BR")      ← persisted to settings.json

    (next Tkinter event-loop cycle)
    │
    ▼
All registered view._refresh_labels() methods execute:
    ├── SuppliersView: nav labels, column headers, buttons → Portuguese
    ├── PurchaseOrdersView: pipeline headers, action buttons → Portuguese
    ├── DashboardView: KPI card names → Portuguese
    ├── ... (all 14 views)
    └── App._refresh_nav_labels():
            ├── "Dashboard"       → "Painel de Controle"
            ├── "Inventory"       → "Estoque"
            ├── "Purchase Orders" → "Ordens de Compra"
            └── ... (12 nav buttons)

Result: entire UI reflects Portuguese within one Tkinter event-loop tick (~40–120 ms)
```

### 5.2 Application Startup with Saved Language

```
main.py → LoginView shown
    │
    ▼
App.__init__(current_user=user)
    ├── saved_lang = SettingsService().get("language", "en")   → "pt_BR"
    ├── if saved_lang != "en":
    │       TranslationService.switch_language("pt_BR")
    │           → Loads .mo BEFORE any view is constructed
    └── Views constructed using _() → already return PT-BR strings at construction time

Result: app opens in the user's preferred language with zero visible English flash
```

---

## 6. Plural Forms

Python's `gettext.ngettext()` handles locale-specific plural rules. The `Plural-Forms` header in each `.po` file defines the rule:

| Locale | Plural-Forms header | Rule |
|---|---|---|
| `en` | `nplurals=2; plural=(n != 1);` | 1 item → singular; everything else → plural |
| `pt_BR` | `nplurals=2; plural=(n > 1);` | 1 item → singular; n > 1 → plural (0 uses singular form in Brazilian Portuguese) |
| `es` | `nplurals=2; plural=(n != 1);` | Same as English |

**Usage example in `ImportWizardView` step 5:**

```python
from src.ui.i18n import ngettext

imported = 18
skipped  = 2

# Renders correctly in all three locales:
imported_label = ngettext(
    "%(n)d row imported", "%(n)d rows imported", imported
) % {"n": imported}

skipped_label = ngettext(
    "%(n)d row skipped", "%(n)d rows skipped", skipped
) % {"n": skipped}
```

| n | EN | PT-BR | ES |
|---|---|---|---|
| 0 | "0 rows imported" | "0 linha importada" | "0 filas importadas" |
| 1 | "1 row imported" | "1 linha importada" | "1 fila importada" |
| 18 | "18 rows imported" | "18 linhas importadas" | "18 filas importadas" |

---

## 7. New Configuration Constants (`config/constants.py`)

| Constant | Default | Description |
|---|---|---|
| `SUPPORTED_LANGUAGES` | `("en", "pt_BR", "es")` | All valid locale codes; used to validate `SettingsService.set("language", ...)` |
| `LANGUAGE_DISPLAY_NAMES` | `{"en": "English", "pt_BR": "Português", "es": "Español"}` | Display names for the language dropdown |
| `DEFAULT_LANGUAGE` | `"en"` | Fallback locale when `settings.json` is absent or value is invalid |
| `LOCALE_DIR` | `"locale"` | Root directory for `.po`/`.mo` files (relative to repo root) |
| `I18N_DOMAIN` | `"logistics_dss"` | gettext domain name; maps to `logistics_dss.mo` file names |

---

## 8. Technology Stack (Phase 9 Additions)

No new third-party packages required. All Phase 9 functionality uses Python's standard library and packages already installed from Phases 1–8:

| Capability | Package | Usage |
|---|---|---|
| Translation catalogs | Python `gettext` (stdlib) | `gettext.translation()` loads `.mo`; `GNUTranslations.gettext()` / `.ngettext()` for lookup |
| `.po` → `.mo` compilation | `msgfmt` (gettext tools, system) | `msgfmt locale/pt_BR/LC_MESSAGES/logistics_dss.po -o logistics_dss.mo` |
| `.pot` extraction | `python -m pygettext` (stdlib) | Scans source for `_()` calls; outputs `.pot` template |
| File I/O | Python `pathlib` (stdlib) | `_LOCALE_DIR` path resolution; `.po` file reading in completeness tests |
| UI | CustomTkinter (Phase 1) | `CTkLabel.configure(text=_(…))` for widget updates |

**`requirements.txt`:** No new entries.

**`packaging/logistics_dss.spec` update (datas extension):**

```python
# Add locale/ directory to datas so .mo files are bundled:
datas=[
    ("../config/",   "config/"),
    ("../assets/",   "assets/"),
    ("../locale/",   "locale/"),       # ← NEW in Phase 9
    (str(Path(sys.prefix) / "lib/python3.12/site-packages/customtkinter"),
     "customtkinter"),
],
```

---

## 9. Implementation Tasks

### 9.1 Locale Infrastructure (Priority: High)

| # | Task | Module | Effort |
|---|---|---|---|
| T9-01 | Add language constants to `config/constants.py` | `config/constants.py` | 10 min |
| T9-02 | Create `locale/` directory structure; write English master `.po` file (~280 strings) | `locale/en/…` | 45 min |
| T9-03 | Write Brazilian Portuguese `.po` translations (~280 strings) | `locale/pt_BR/…` | 3 h |
| T9-04 | Write Spanish `.po` translations (~280 strings) | `locale/es/…` | 2.5 h |
| T9-05 | Compile all three `.po` files to `.mo` via `msgfmt`; verify binary loads without error | Bash | 15 min |

### 9.2 Translation Infrastructure (Priority: High)

| # | Task | Module | Effort |
|---|---|---|---|
| T9-06 | Implement `TranslationService` (module-level state + observer pattern) | `src/services/translation_service.py` | 2 h |
| T9-07 | Implement `src/ui/i18n.py` (`_()` + `ngettext()` shortcuts) | `src/ui/i18n.py` | 20 min |
| T9-08 | Implement `I18nMixin` (`enable_i18n`, `_on_language_changed`, `_refresh_labels`, `disable_i18n`) | `src/ui/mixins/i18n_mixin.py` | 45 min |

### 9.3 View i18n (Priority: High)

| # | Task | Module | Effort |
|---|---|---|---|
| T9-09 | Wrap all string literals in 14 views + `app.py` with `_()` calls | All views + `src/ui/app.py` | 4 h |
| T9-10 | Implement `_refresh_labels()` in all 14 views; rebuild `DataTable` headers on language switch | All views | 4 h |
| T9-11 | Wire `SettingsView` language dropdown to `TranslationService.switch_language()` | `src/ui/views/settings_view.py` | 1 h |
| T9-12 | Extend `App`: `_nav_buttons` list, `_refresh_nav_labels()`, startup language initialisation | `src/ui/app.py` | 45 min |

### 9.4 Tooling & Packaging (Priority: Medium)

| # | Task | Module | Effort |
|---|---|---|---|
| T9-13 | Create `tools/extract_strings.py` (POT extraction + completeness check) | `tools/extract_strings.py` | 1 h |
| T9-14 | Update `packaging/logistics_dss.spec` to include `locale/` in `datas`; rebuild `.app`; verify PT-BR switch works inside bundle | `packaging/logistics_dss.spec` | 45 min |

### 9.5 Testing (Priority: High)

| # | Task | Module | Effort |
|---|---|---|---|
| T9-15 | Write `tests/test_translation_service.py` (8 tests) | `tests/test_translation_service.py` | 1.5 h |
| T9-16 | Write `tests/test_locale_completeness.py` (6 tests) | `tests/test_locale_completeness.py` | 1 h |
| T9-17 | Write `tests/test_language_switch.py` (5 tests) | `tests/test_language_switch.py` | 1 h |

**Total estimated effort: 24–28 hours**

---

## 10. Implementation Order

```
Step 1: Constants + Locale Files
  ├── T9-01: Language constants
  ├── T9-02: English master .po
  ├── T9-03: Portuguese .po translations
  ├── T9-04: Spanish .po translations
  └── T9-05: Compile all .po → .mo

Step 2: Translation Infrastructure
  ├── T9-06: TranslationService (switch_language + observers)
  ├── T9-07: i18n.py (_() shorthand)
  └── T9-08: I18nMixin base class

Step 3: View i18n (can parallelise across views)
  ├── T9-09: Wrap string literals with _() in all 14 views + app.py
  ├── T9-10: Implement _refresh_labels() in all views
  ├── T9-11: Wire SettingsView language dropdown
  └── T9-12: App _refresh_nav_labels() + startup language init

Step 4: Tooling & Packaging
  ├── T9-13: tools/extract_strings.py
  └── T9-14: Update packaging spec; rebuild .app; smoke-test PT-BR in bundle

Step 5: Testing
  ├── T9-15: test_translation_service.py (8 tests)    ← after T9-06
  ├── T9-16: test_locale_completeness.py (6 tests)    ← after T9-02–T9-05
  └── T9-17: test_language_switch.py (5 tests)        ← after T9-10
```

---

## 11. Risk Assessment

| Risk | Impact | Probability | Mitigation |
|---|---|---|---|
| DataTable header rebuild causes visible flash or scroll-position loss during language switch | Medium | Medium | Rebuild is fast (< 50 ms for 20 rows); cached row data re-rendered immediately; no network I/O in the refresh path |
| CTkOptionMenu selected value becomes stale after language switch if values list was translated and value was stored as a display string (not a code) | Medium | Medium | All internal `CTkOptionMenu` selections (status filter, ABC class) store English code values; only display strings are translated; mapping dicts convert code ↔ display in both directions |
| `.mo` binary not included in PyInstaller bundle → entire app falls back to English silently in non-English mode | High | Low | `locale/` added explicitly to `datas` in spec; verified in T9-14 smoke test with PT-BR active |
| Untranslated strings (new code added post-Phase 9) appear in English in a non-English UI | Low | High | `tools/extract_strings.py --check-completeness` run in CI before each release; exit-1 on missing translations prevents shipping incomplete catalogs |
| `.po` file encoding inconsistency: translator saves in non-UTF-8 encoding → `gettext.translation()` raises `UnicodeDecodeError` at load | Medium | Low | `Content-Type: text/plain; charset=UTF-8` enforced in all `.po` headers; `test_translation_service.py::test_all_mo_files_load_without_error` catches this at test time |
| Brazilian Portuguese (pt_BR) vs European Portuguese (pt_PT) dialect choice causes incorrect phrasing for PT-PT users | Low | Low | Per original requirement, PT-BR is the single supported Portuguese variant; documented in README; PT-PT support can be added as a future locale |
| Status badge text translated in the UI but stored in English in the database → inconsistency if a badge string is used as a filter value | Low | Low | Status filter dropdowns use English code values internally; translated display strings are presentation-only; database queries always use English constants |
| `msgfmt` not available on developer machine (not part of Python stdlib; part of GNU gettext tools) | Medium | Medium | `tools/extract_strings.py` checks for `msgfmt` presence; README documents `brew install gettext` (macOS) / `apt install gettext` (Linux); `msgfmt` output committed to repo so end-users never need it |

---

## 12. Testing Strategy

### 12.1 Translation Service Tests (`tests/test_translation_service.py`)

| Test | Validates |
|---|---|
| `test_switch_to_pt_br_returns_portuguese` | `switch_language("pt_BR")`; `translate("Dashboard")` returns `"Painel de Controle"` |
| `test_switch_to_es_returns_spanish` | `switch_language("es")`; `translate("Suppliers")` returns `"Proveedores"` |
| `test_switch_to_en_returns_english` | After PT-BR active, `switch_language("en")`; `translate("Reports")` returns `"Reports"` |
| `test_unknown_locale_falls_back_to_english` | `switch_language("fr")` (no French .mo); `translate("Cancel")` returns `"Cancel"` (msgid unchanged) |
| `test_observer_called_on_switch` | Subscribe a mock callback; `switch_language("pt_BR")`; callback called once with `"pt_BR"` |
| `test_unsubscribed_observer_not_called` | Subscribe then `unsubscribe`; `switch_language("es")`; callback not called |
| `test_ngettext_plural_pt_br` | `switch_language("pt_BR")`; `ntranslate("%(n)d row imported", "%(n)d rows imported", 2)` returns PT-BR plural form |
| `test_all_mo_files_load_without_error` | `switch_language("en")`, `switch_language("pt_BR")`, `switch_language("es")` in sequence — no exception raised |

### 12.2 Locale Completeness Tests (`tests/test_locale_completeness.py`)

| Test | Validates |
|---|---|
| `test_pt_br_has_all_en_keys` | Every `msgid` in `en/logistics_dss.po` has a non-empty `msgstr` in `pt_BR/logistics_dss.po` |
| `test_es_has_all_en_keys` | Every `msgid` in `en/logistics_dss.po` has a non-empty `msgstr` in `es/logistics_dss.po` |
| `test_no_obsolete_pt_br_keys` | No `msgid` in `pt_BR/logistics_dss.po` is absent from `en/logistics_dss.po` (no orphaned translations) |
| `test_no_obsolete_es_keys` | No `msgid` in `es/logistics_dss.po` is absent from `en/logistics_dss.po` |
| `test_plural_forms_defined_in_all_locales` | `Plural-Forms` header present and non-empty in all three `.po` files |
| `test_mo_files_match_po_files` | `msgfmt --statistics` confirms each `.mo` has the same string count as its corresponding `.po` |

### 12.3 Language Switch Tests (`tests/test_language_switch.py`)

| Test | Validates |
|---|---|
| `test_i18n_shorthand_uses_current_locale` | `switch_language("pt_BR")`; `_("Inventory")` returns `"Estoque"` |
| `test_switch_persists_in_settings` | `_on_language_selected("Português")` (SettingsView handler); `SettingsService().get("language")` returns `"pt_BR"` |
| `test_startup_loads_saved_language` | `SettingsService().set("language", "es")`; new `TranslationService` init picks up saved language; `translate("Cancel")` returns `"Cancelar"` |
| `test_i18n_mixin_observer_registered` | `I18nMixin.enable_i18n()` called; `TranslationService._observers` contains `view._on_language_changed` |
| `test_i18n_mixin_observer_deregistered_on_disable` | `disable_i18n()` removes the callback; `switch_language("es")`; `_refresh_labels` not called on destroyed view |

---

## 13. Non-Functional Requirements (Phase 9)

| Requirement | Target | Validation Method |
|---|---|---|
| Language switch response time (full UI refresh) | < 500 ms | Manual smoke test; all 14 views rebuild synchronously within one Tkinter event loop cycle |
| `.mo` file load time at startup | < 50 ms | Timed in `test_translation_service.py::test_all_mo_files_load_without_error` |
| Startup language initialisation (non-English saved preference) | 0 visible English flash | Startup calls `switch_language()` before any view construction; first `_()` call already returns correct locale |
| PT-BR catalog completeness | 100% (all ~280 strings) | `test_pt_br_has_all_en_keys` |
| ES catalog completeness | 100% (all ~280 strings) | `test_es_has_all_en_keys` |
| No regression in non-GUI coverage | ≥ 90% | `pytest --cov=src --ignore=src/ui` |
| PyInstaller bundle with PT-BR active | Full UI in Portuguese | T9-14 packaging smoke test: launch `.app` with `settings.json` `"language": "pt_BR"`; all labels in Portuguese |
| `tools/extract_strings.py --check-completeness` exit code | 0 (no missing strings) | Part of Phase 9 completion verification |

---

## 14. Phase 9 Exit Criteria

- [ ] `TranslationService.switch_language("pt_BR")` loads the PT-BR `.mo` file without error; `translate("Dashboard")` returns `"Painel de Controle"` (`test_switch_to_pt_br_returns_portuguese`)
- [ ] `TranslationService.switch_language("fr")` (unsupported locale) falls back silently to English; `translate("Cancel")` returns `"Cancel"` (`test_unknown_locale_falls_back_to_english`)
- [ ] PT-BR locale catalog is 100% complete: every English `msgid` has a translated `msgstr` (`test_pt_br_has_all_en_keys`)
- [ ] ES locale catalog is 100% complete: every English `msgid` has a translated `msgstr` (`test_es_has_all_en_keys`)
- [ ] `ngettext` plural forms return correct PT-BR form for n=0, n=1, n=2 (`test_ngettext_plural_pt_br`)
- [ ] Observer is registered on `enable_i18n()` and deregistered on `disable_i18n()` (`test_i18n_mixin_observer_registered`, `test_i18n_mixin_observer_deregistered_on_disable`)
- [ ] `SettingsView` language dropdown: selecting "Português" calls `switch_language("pt_BR")` and persists `"pt_BR"` to `settings.json` (`test_switch_persists_in_settings`)
- [ ] App opens in Portuguese when `settings.json` contains `"language": "pt_BR"` — no English strings visible on startup (manual smoke test)
- [ ] Switching language in `SettingsView` updates all sidebar nav labels and all visible view labels without restarting the app (manual smoke test — EN → PT-BR → ES → EN cycle)
- [ ] `tools/extract_strings.py --check-completeness` exits with code 0 and prints `[pt_BR] Complete ✓` and `[es] Complete ✓`
- [ ] PyInstaller `.app` with `settings.json` `"language": "pt_BR"`: all UI text in Portuguese; no English fallback visible (T9-14 packaging smoke test)
- [ ] All 19 new Phase 9 tests pass; total test count = 389; 0 regressions in Phase 1–8 tests

---

## 15. Transition to Phase 10

Phase 9 completes the multilingual requirement from the original project specification. The remaining post-launch roadmap items are:

**Phase 10 candidates:**

1. **ERP Database Connector:**
   The Phase 8 import wizard accepts CSV/Excel. Phase 10 would add a pluggable `DataConnector` framework: a `CSVConnector` (existing, now formalised), plus `PostgreSQLConnector`, `MySQLConnector`, and a `GenericODBCConnector`. The `SettingsView` gains a Connections tab where ADMIN users configure one or more source connections (host, port, credentials, driver). The `ImportWizardView` gains a "Connect to Database" source option alongside "Browse for file".

2. **Multi-Location Inventory:**
   A `Location` ORM model (`id`, `name`, `code`, `type: WAREHOUSE | STORE | DC`, `active`) and a `ProductLocation` ORM model (`product_id`, `location_id`, `current_stock`, `reserved_stock`) extend the inventory layer. All stock-level views gain a location filter. Inter-location stock transfer workflows are added: a `StockTransfer` ORM model with `from_location_id`, `to_location_id`, `product_id`, `qty`, `status`, and `transferred_at`.

3. **Mobile Companion API:**
   A lightweight `FastAPI` layer (`src/api/`) exposes read-only JSON endpoints backed by existing services (`KPIService.get_executive_kpis()`, `ReportService.get_po_pipeline()`, `AlertService.get_active_alerts()`). An ADMIN-only API token (`api_token` field on `User`) authenticates requests. The Phase 8 `APScheduler` infrastructure triggers a nightly push of the KPI snapshot to a configurable webhook URL for mobile dashboard consumption.

**Prerequisites from Phase 9 used by Phase 10:**
- `TranslationService` observer pattern adopted by Phase 10's `DataConnector` status messages
- Language-aware error messages in `ImportWizardService` (already using `_()`) automatically propagate to the Phase 10 ERP connector's validation output
- PT-BR and ES string catalogs extended with Phase 10 connector and location strings via `tools/extract_strings.py` workflow

---

## Revision History

| Version | Date | Changes |
|---|---|---|
| 1.0 | 2026-02-24 | Initial Phase 9 implementation plan |
